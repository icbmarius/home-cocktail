<%- include("partials/head", { title: "Cocktail Menu" }) %>

<section class="page-head menu-head">
  <div>
    <p class="eyebrow">House Selection</p>
    <h1>Cocktail Menu</h1>
    <p>Alege un cocktail din lista si apoi apasa <strong>Order</strong>.</p>
  </div>
</section>

<section class="grid">
  <% if (!cocktails.length) { %>
    <div class="card">
      <h3>Meniul este gol</h3>
      <p>Gazda va adauga in curand cocktail-urile disponibile.</p>
    </div>
  <% } %>

  <% cocktails.forEach((item) => { %>
    <article
      class="card cocktail-card <%= selectedId === item.id ? "is-selected" : "" %>"
      data-cocktail-id="<%= item.id %>"
      data-cocktail-name="<%= item.name %>"
    >
      <% if (item.image_path) { %>
        <img class="cocktail-image" src="<%= item.image_path %>" alt="<%= item.name %>" />
      <% } %>
      <h3><%= item.name %></h3>
      <p class="ingredients"><%= item.ingredients %></p>
      <button class="btn btn-small btn-secondary select-cocktail-btn" type="button">Selecteaza</button>
    </article>
  <% }) %>
</section>

<section class="card order-launch">
  <h2>Comanda</h2>
  <p id="selectedDrinkLabel" class="muted">Nu ai selectat inca un cocktail.</p>
  <button class="btn order-main-btn" id="openOrderBtn" type="button" <%= cocktails.length ? "" : "disabled" %>>
    Order
  </button>

  <% if (orderError) { %>
    <p class="alert"><%= orderError %></p>
  <% } %>

  <% if (orderSuccess) { %>
    <p class="success"><%= orderSuccess %></p>
  <% } %>

  <% if (!whatsappConfigured) { %>
    <p class="muted">WhatsApp nu este configurat inca. Comanda va fi doar salvata in sistem.</p>
  <% } %>
</section>

<section class="card order-sheet" id="orderSheet" <%= orderError ? "" : "hidden" %>>
  <h2>Order Form</h2>
  <form class="form" method="POST" action="/order">
    <label>
      Numele tau *
      <input id="customerNameField" type="text" name="customer_name" required placeholder="Ex: Alex" />
    </label>

    <label>
      Bautura *
      <input id="cocktailNameField" type="text" readonly placeholder="Selecteaza un cocktail de mai sus" />
      <input id="cocktailIdField" type="hidden" name="cocktail_id" value="<%= selectedId || "" %>" />
    </label>

    <label>
      Detalii
      <textarea name="note" rows="3" placeholder="Ex: fara gheata, extra lime"></textarea>
    </label>

    <button class="btn" type="submit">Trimite comanda</button>
  </form>
</section>

<script id="cocktail-json" type="application/json">
  <%- JSON.stringify(cocktails.map((item) => ({ id: item.id, name: item.name }))) %>
</script>
<script>
  (() => {
    const cards = Array.from(document.querySelectorAll("[data-cocktail-id]"));
    const orderSheet = document.getElementById("orderSheet");
    const openOrderBtn = document.getElementById("openOrderBtn");
    const label = document.getElementById("selectedDrinkLabel");
    const cocktailNameField = document.getElementById("cocktailNameField");
    const cocktailIdField = document.getElementById("cocktailIdField");
    const customerNameField = document.getElementById("customerNameField");
    const cocktails = JSON.parse(document.getElementById("cocktail-json").textContent);
    let selectedId = Number.parseInt("<%= selectedId || "" %>", 10);
    if (Number.isNaN(selectedId)) selectedId = null;

    function pickCocktail(id) {
      const selected = cocktails.find((c) => c.id === id);
      selectedId = selected ? selected.id : null;

      cards.forEach((card) => {
        const cardId = Number.parseInt(card.dataset.cocktailId, 10);
        card.classList.toggle("is-selected", cardId === selectedId);
      });

      if (selected) {
        label.textContent = `Selectat: ${selected.name}`;
        cocktailNameField.value = selected.name;
        cocktailIdField.value = String(selected.id);
        openOrderBtn.disabled = false;
      } else {
        label.textContent = "Nu ai selectat inca un cocktail.";
        cocktailNameField.value = "";
        cocktailIdField.value = "";
      }
    }

    cards.forEach((card) => {
      card.querySelector(".select-cocktail-btn").addEventListener("click", () => {
        const id = Number.parseInt(card.dataset.cocktailId, 10);
        pickCocktail(id);
      });
    });

    openOrderBtn.addEventListener("click", () => {
      if (!selectedId) {
        label.textContent = "Selecteaza un cocktail inainte de a comanda.";
        return;
      }
      orderSheet.hidden = false;
      orderSheet.scrollIntoView({ behavior: "smooth", block: "start" });
      customerNameField.focus();
    });

    pickCocktail(selectedId);
  })();
</script>

<%- include("partials/foot") %>
